// Configuração dos dados
const tempData = [];
const humidityData = [];
const timeLabels = [];

const maxDataPoints = 10; // 10 pontos para 5 minutos com intervalo de 30 segundos

const combinedCtx = document.getElementById('combinedChart').getContext('2d');

// Gráfico combinado de Temperatura (eixo Y esquerdo) e Umidade (eixo Y direito)
const combinedChart = new Chart(combinedCtx, {
    type: 'line',
    data: {
        labels: timeLabels, // Usamos o mesmo eixo X com base no tempo ajustado para Brasília
        datasets: [
            {
                label: 'Temperatura (°C)',
                data: tempData,
                borderColor: 'rgba(255, 99, 132, 1)',
                fill: false,
                tension: 0.1,
                yAxisID: 'y1'
            },
            {
                label: 'Umidade (%)',
                data: humidityData,
                borderColor: 'rgba(54, 162, 235, 1)',
                fill: false,
                tension: 0.1,
                yAxisID: 'y2'
            }
        ]
    },
    options: {
        responsive: true,
        scales: {
            // ✅ ALTERADO: eixo X agora é de tempo com formato adequado
            x: {
                type: 'time',
                time: {
                    unit: 'second', // unidade em segundos
                    stepSize: 10, // exibir a cada 10 segundos
                    tooltipFormat: 'dd/MM/yyyy HH:mm:ss', // Tooltip ao passar o mouse
                    displayFormats: {
                        minute: 'dd/MM HH:mm:ss', // Eixo X
                        second: 'dd/MM HH:mm:ss'
                    }
                },
                ticks: {
                    source: 'auto',
                    autoSkip: false,       // ← Desabilita o autoSkip
                    maxRotation: 0,        // ← Evita rotação
                    minRotation: 0,        // ← Evita rotação
                },

                title: {
                    display: true,
                    text: 'Horário (Brasília)'
                }
            },
            y1: {
                beginAtZero: false,
                position: 'left'
            },
            y2: {
                beginAtZero: false,
                position: 'right'
            }
        }
    }
});

// ✅ Função para converter timestamp UTC para horário de Brasília
function converterParaHorarioBrasilia(timestampUTC) {
    const dataUTC = new Date(timestampUTC);
    // Subtrai 3 horas para ajustar para UTC-3 (Brasília)
    return new Date(dataUTC.getTime() - 3 * 60 * 60 * 1000);
}

// ✅ Função para atualizar os gráficos com os dados mais recentes
function fetchData() {
    fetch('https://coletor-de-tempo.vercel.app/api')
        .then(response => response.json())
        .then(data => {
            // Converte timestamp do banco para horário de Brasília
            const dataHoraBrasilia = converterParaHorarioBrasilia(data.timestamp);

            const temperature = data.temperatura;
            const humidity = data.umidade;

            // Mantém apenas os últimos N pontos
            if (timeLabels.length >= maxDataPoints) {
                timeLabels.shift();
                tempData.shift();
                humidityData.shift();
            }

            // ✅ Usa data e hora como label no eixo X
            timeLabels.push(dataHoraBrasilia);
            tempData.push(temperature);
            humidityData.push(humidity);

            combinedChart.update();
        })
        .catch(error => console.error('Erro ao obter dados da API:', error));
}

// Atualizar os dados a cada 10 segundos
setInterval(fetchData, 10000);

// Chamada inicial
fetchData();
